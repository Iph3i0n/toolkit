<s:meta name="effuse-start">
  <attr name="client">The API client for the SSO Server</attr>
</s:meta>

<script>
  import { SsoClient } from "../integrations/sso";
  import { UseUrlParameters } from "../integrations/url";

  let sso = await SsoClient.Attempt();
  let mode = "login";

  async function on_login({ FormData }) {
    sso = await SsoClient.Login(FormData.Email, FormData.Password);
  }

  async function on_register({ FormData }) {
    sso = await SsoClient.Register({
      user_name: FormData.UserName,
      email: FormData.Email,
      password: FormData.Password,
    });
  }
</script>

<script on="mut">
  const { server_id } = UseUrlParameters(self, "/servers/:server_id");
</script>

<style>
  :host {
    display: block;
    height: 100vh;
    overflow: hidden;
  }

  .app-body {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  .app-body l-header {
    width: 100%;
    margin-bottom: 0;
  }

  .app-content {
    width: 100%;
    flex: 1;
  }

  .login-form {
    margin: auto;
    max-width: 400px;
    padding: 1rem;
  }
</style>

<s:if check=":!sso">
  <div class="login-form">
    <s:if check=":mode === 'login'">
      <f-form submit="event-only" on:Submitted="on_login">
        <l-row>
          <l-col xs="12">
            <f-input name="Email" required>Email</f-input>
          </l-col>
          <l-col xs="12">
            <f-input name="Password" required sensitive>Password</f-input>
          </l-col>
          <l-col xs="12">
            <f-button type="submit">Login</f-button>
            <f-button
              type="button"
              colour="contrast"
              on:click="() => (mode = 'register')"
            >
              New to Effuse?
            </f-button>
          </l-col>
        </l-row>
      </f-form>
    </s:if>
    <s:if check=":mode === 'register'">
      <f-form submit="event-only" on:Submitted="on_register">
        <l-row>
          <l-col xs="12">
            <f-input name="UserName" validate="^[a-zA-Z0-9]+$" required>
              Username
            </f-input>
          </l-col>
          <l-col xs="12">
            <f-input name="Email" type="email" required>Email</f-input>
          </l-col>
          <l-col xs="12">
            <f-input name="Password" required sensitive>Password</f-input>
          </l-col>
          <l-col xs="12">
            <f-button type="submit">Register</f-button>
            <f-button
              type="button"
              colour="contrast"
              on:click="() => (mode = 'login')"
            >
              Already got an account?
            </f-button>
          </l-col>
        </l-row>
      </f-form>
    </s:if>
  </div>
</s:if>

<s:if check=":sso">
  <effuse-config client=":sso" />
  <div class="app-body">
    <l-container flush class="app-content">
      <u-route path="/join-server">
        <effuse-join-server client=":sso" />
      </u-route>
      <u-route path="/profile">
        <effuse-profile client=":sso" />
      </u-route>

      <u-route path="/servers/:server_id">
        <s:if check=":!!server_id">
          <server-viewer sso_client=":sso" />
        </s:if>
      </u-route>
    </l-container>
  </div>
</s:if>
